<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>クーポンルーレット</title>
	<style>
		#roulette-container {
			width: 300px;
			height: 300px;
			position: relative;
			margin: 20px auto;
		}

		#roulette {
			width: 100%;
			height: 100%;
			border-radius: 50%;
			transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
			background: conic-gradient(from 0deg,
					#ff6b6b 0deg 72deg,
					/* COUPON_TYPE1 */
					#feca57 72deg 144deg,
					/* COUPON_TYPE2 */
					#48dbfb 144deg 216deg,
					/* COUPON_TYPE3 */
					#ff9ff3 216deg 288deg,
					/* COUPON_TYPE4 */
					#cfd8dc 288deg 360deg
					/* はずれ */
				);
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			transform: rotate(288deg);
			/* 初期位置を288degに設定 */
		}

		.coupon-item {
			position: absolute;
			top: 0;
			right: 50%;
			transform-origin: 100% 100%;
			width: 50%;
			height: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: bold;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
			font-size: 14px;
			text-align: center;
			padding: 0 10px;
		}

		.arrow {
			position: absolute;
			top: -30px;
			left: 50%;
			transform: translateX(-50%);
			width: 0;
			height: 0;
			border-left: 20px solid transparent;
			border-right: 20px solid transparent;
			border-top: 30px solid #333;
		}

		#coupon-result {
			margin-top: 20px;
			font-size: 2em;
			font-weight: bold;
			color: green;
		}

		button {
			margin-top: 20px;
			padding: 10px 20px;
			font-size: 1.2em;
			cursor: pointer;
		}
	</style>
</head>

<body>

    <h1>クーポンルーレット</h1>

    <div id="roulette-container">
        <div id="roulette">
            <div class="coupon-item" data-coupon="COUPON_TYPE1" style="transform: rotate(0deg)">半額</div>
            <div class="coupon-item" data-coupon="COUPON_TYPE2" style="transform: rotate(288deg)">1000円引き</div>
            <div class="coupon-item" data-coupon="COUPON_TYPE3" style="transform: rotate(216deg)">ドリンク１杯無料</div>
            <div class="coupon-item" data-coupon="COUPON_TYPE4" style="transform: rotate(144deg)">席料 無料</div>
            <div class="coupon-item" data-coupon="MISS" style="transform: rotate(72deg)">はずれ</div>
        </div>
        <div class="arrow"></div>
    </div>

    <div id="coupon-result"></div>
    <button id="spin-button" onclick="startRoulette()">ルーレットを回す</button>
    <button id="view-coupon-button" style="display:none;" onclick="viewCoupon()">獲得したクーポンを見る</button>
    <button id="back-to-list-button" style="display:none;" onclick="backToList()">クーポン一覧に戻る</button>

    <audio id="roulette-sound">
        <source src="/audio/SE114.mp3" type="audio/mpeg">
        お使いのブラウザは音声タグに対応していません。
    </audio>

    <script>
        let totalRotation = 0;
        let couponType = ''; // クーポンタイプを保持
        let coupon = null; // couponオブジェクトを保持する変数

        function startRoulette() {
            const spinButton = document.getElementById('spin-button');
            const viewButton = document.getElementById('view-coupon-button');
            const backToListButton = document.getElementById('back-to-list-button');

            spinButton.style.display = 'none';
            viewButton.style.display = 'none';
            backToListButton.style.display = 'none';

            fetch('/couponcreate')
                .then(response => response.json())
                .then(data => {
                    couponType = data.couponType; // 受け取ったクーポンタイプを設定
                    coupon = data.coupon; // couponオブジェクトを保持

                    const targetRotation = calculateTargetRotation(couponType);
                    const additionalRotation = 1440 + targetRotation; // 1440度回転させる
                    totalRotation += additionalRotation;

                    const roulette = document.getElementById('roulette');
                    roulette.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                    roulette.style.transform = `rotate(${totalRotation}deg)`;

                    setTimeout(() => {
                        if (couponType === null) {
                            displayResult('MISS');
                            backToListButton.style.display = 'block';
                        } else {
                            displayResult(couponType);
                            viewButton.style.display = 'block';
                        }
                    }, 5000);
                })
                .catch(error => {
                    console.error('Error fetching coupon:', error);
                    spinButton.style.display = 'block'; // エラー時にボタンを再表示
                });

            const sound = document.getElementById('roulette-sound');
            sound.currentTime = 0;
            sound.play();
        }

        function backToList() {
            window.location.href = '/couponlist'; // クーポン一覧に戻る
        }

        function calculateTargetRotation(couponType) {
            let min, max;

            switch (couponType) {
                case 'COUPON_TYPE1':
                    min = 1; max = 71;
                    break;
                case 'COUPON_TYPE2':
                    min = 73; max = 143;
                    break;
                case 'COUPON_TYPE3':
                    min = 145; max = 215;
                    break;
                case 'COUPON_TYPE4':
                    min = 217; max = 287;
                    break;
                case 'MISS':
                default:
                    min = 289; max = 359;
                    break;
            }

            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function displayResult(couponType) {
            const result = document.getElementById('coupon-result');
            let couponMessage;

            switch (couponType) {
                case 'COUPON_TYPE1':
                    couponMessage = "半額のクーポンを獲得しました！";
                    break;
                case 'COUPON_TYPE2':
                    couponMessage = "1000円引きのクーポンを獲得しました！";
                    break;
                case 'COUPON_TYPE3':
                    couponMessage = "ドリンク１杯無料のクーポンを獲得しました！";
                    break;
                case 'COUPON_TYPE4':
                    couponMessage = "席料無料のクーポンを獲得しました！";
                    break;
                default:
                    couponMessage = "残念ですが、はずれです";
                    break;
            }

            result.innerText = couponMessage;
        }

        function viewCoupon() {
            const couponIdMap = {
                'COUPON_TYPE1': 1,
                'COUPON_TYPE2': 2,
                'COUPON_TYPE3': 3,
                'COUPON_TYPE4': 4,
                'MISS': 0 // はずれの場合のID
            };
            const couponId = couponIdMap[couponType];
            window.location.href = `/couponresult?id=${couponId}`; // 取得したクーポンを表示する
        }
    </script>

</body>

</html>